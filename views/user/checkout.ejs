<%-include('header')-%>

<div id="page-content">
    <!--Page Title-->
    <div class="page section-header text-center">
        <div class="page-title">
            <div class="wrapper"><h1 class="page-width">Checkout</h1></div>
          </div>
    </div>
    <!--End Page Title-->
    
    <div class="container">
        

        <div class="row billing-fields">
            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 sm-margin-30px-bottom">
                <div class="create-ac-content bg-light-gray padding-20px-all">

                    <div id="your-address" class="coupon-checkout-content">
                        <div class="discount-coupon">
                            <h2 class="login-title mb-3">Billing Address</h2>
                    
                            <% billingDetails.forEach((billingDetail, index) => { %>
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <span>First Name:</span>
                                        <span><%= billingDetail.name %></span>
                                    </div>
                    
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <span>Telephone:</span>
                                        <span><%= billingDetail.telephone %></span>
                                    </div>
                                </div>
                    
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <span>Address:</span>
                                        <span><%= billingDetail.address %></span>
                                    </div>
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <span>City:</span>
                                        <span><%= billingDetail.city %></span>
                                    </div>
                                </div>
                    
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <span>Post Code:</span>
                                        <span><%= billingDetail.postCode %></span>
                                    </div>
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <span>Region / State:</span>
                                        <span><%= billingDetail.regionState %></span>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <span>select</span>
                                        <input type="radio" name="address-selection" value="address1" data-user-id="<%=cartItems[0].userId %>"  data-address-id="<%= billingDetail._id %>">
                                    </div>
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <a href="" class="btn btn--secondary billingAddress__remove" title="Remove tem" data-user-id="<%=cartItems[0].userId %>"  data-address-id="<%= billingDetail._id %>"><i class="icon icon anm anm-times-l"></i></a>

                                    </div>
                                </div>
                                <hr>
                            <% }); %>
                        </div>
                    </div>

                    





                    <div class="customer-box customer-coupon">
                        <h3 class="font-15 xs-font-13"><i class=""></i>  <a href="#add-address" class="text-white text-decoration-underline" data-toggle="collapse">Add Address</a></h3>
                    </div>  

                    
                    
                    <div id="add-address" class="collapse coupon-checkout-content">
                        <div class="discount-coupon">
                            <form  id="address-form" action="/address-added" method="POST">
                                    <h2 class="login-title mb-3">Billing details</h2>
                                    <div class="row">
                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                            <label for="input-name">First Name <span class="required-f">*</span></label>
                                            <input name="name"  id="input-name" type="text">
                                            <div class="error" style="color: red;"></div>
                                        </div>

                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                            <label for="input-telephone">Telephone <span class="required-f">*</span></label>
                                            <input name="telephone"  id="input-telephone" type="tel">
                                            <div class="error" style="color: red;"></div>
                                        </div>


                                    </div>
                                    
        
                                    <div class="row">
                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                            <label for="input-homeAddress">Address <span class="required-f">*</span></label>
                                            <input name="homeAddress"  id="input-homeAddress" type="text">
                                            <div class="error" style="color: red;"></div>
                                        </div>

                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                            <label for="input-city">City <span class="required-f">*</span></label>
                                            <input name="city"  id="input-city" type="text">
                                            <div class="error" style="color: red;"></div>
                                        </div>

                                    </div>
                                   
                                    <div class="row">
                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                            <label for="input-postcode">Post Code <span class="required-f">*</span></label>
                                            <input name="postcode"  id="input-postcode" type="text">
                                            <div class="error" style="color: red;"></div>
                                        </div>

                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                            <label for="input-zone">Region / State <span class="required-f">*</span></label>
                                            <input name="state"  id="input-state" type="text">
                                            <div class="error" style="color: red;"></div>
                                        </div>
                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                            <button class="btn" style="background-color: cadetblue;" type="submit">Submit</button>
                                        </div>
                                    </div>
                            </form> 
                        </div>
                    </div>




                  

                </div>
               
            </div> 


            

            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                <div class="your-order-payment">
                    <div class="your-order">
                        <h2 class="order-title mb-4">Your Order</h2>



                        <div class="table-responsive-sm order-table"> 
                            <table class="bg-white table table-bordered table-hover text-center">
                                <thead>
                                    <tr>
                                        <th class="text-left">Product Name</th>
                                        <th>Price</th>
                                        <th>Qty</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <% locals.cartItems.forEach(item => { %>

                                <tbody class="font-weight-600" >
                                    <tr>
                                        <td hidden data-product-image="<%= JSON.stringify(item.images) %>" data-cart-id="item._id" class="text-left"><%= item.name %></td>
                                        <td  data-product-id="<%= item.productId %>" data-product-name="<%= item.name %>" data-cart-id="item._id" class="text-left"><%= item.name %></td>

                                        <td data-product-unitPrice="<%= item.unitPrice %>" data-cart-id="item._id">$<%= item.unitPrice %></td>
                                        <td data-product-quantity="<%= item.quantity %>" data-cart-id="item._id"><%=item.quantity%></td>
                                        <td data-product-price="<%= item.price %>" data-cart-id="item._id">$<%= item.price %></td>
                                    </tr>
                                </tbody>
                        <% }); %>

                                <tfoot class="font-weight-600">
                                    <tr>
                                        <td colspan="3" class="text-right">Shipping </td>
                                        <td data-shipping-value="free" >FREE</td>
                                    </tr>
                                    <tr>
                                        <td colspan="3" class="text-right">Tax </td>
                                        <td data-tax-value="<%= taxValue.toFixed(2)%>" >$<%= taxValue.toFixed(2)%> </td>
                                    </tr>
                                    <tr>
                                        <td colspan="3" class="text-right">Grand Total</td>
                                        <td data-grandTotal-value="<%= grandTotal.toFixed(2)%>" >$<%= grandTotal.toFixed(2) %></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>


                        
                    </div>
                    
                    <hr />

                    <div class="your-payment">
                        <h2 class="payment-title mb-3">payment method</h2>
                        <div class="payment-method">
                            <div class="payment-accordion">
                                <div id="accordion" class="payment-section">



                                    <!-- <div class="card mb-2">
                                        <div class="card-header">
                                            <a class="card-link" data-toggle="collapse" href="#collapseOne">Direct Bank Transfer </a>
                                        </div>
                                        <div id="collapseOne" class="collapse" data-parent="#accordion">
                                            <div class="card-body">
                                                <p class="no-margin font-15">Make your payment directly into our bank account. Please use your Order ID as the payment reference. Your order won't be shipped until the funds have cleared in our account.</p>
                                            </div>
                                        </div>
                                    </div> -->


                                    <!-- <div class="card mb-2">
                                        <div class="card-header">
                                            <a class="collapsed card-link" data-toggle="collapse" href="#collapseTwo">Cheque Payment</a>
                                        </div>
                                        <div id="collapseTwo" class="collapse" data-parent="#accordion">
                                            <div class="card-body">
                                                <p class="no-margin font-15">Please send your cheque to Store Name, Store Street, Store Town, Store State / County, Store Postcode.</p>
                                            </div>
                                        </div>
                                    </div> -->



                                    <div class="card margin-15px-bottom border-radius-none">
                                        <div class="card-header">
                                            <a class="collapsed card-link" data-toggle="collapse" href="#collapseThree"> Cash On Delivery </a>
                                        </div>
                                        <!-- <div id="collapseThree" class="collapse" data-parent="#accordion">
                                            <div class="card-body">
                                                <p class="no-margin font-15">Pay via PayPal; you can pay with your credit card if you don't have a PayPal account.</p>
                                            </div>
                                        </div> -->
                                    </div>


                                    <!-- <div class="card mb-2">
                                        <div class="card-header">
                                            <a class="collapsed card-link" data-toggle="collapse" href="#collapseFour"> Payment Information </a>
                                        </div>
                                        <div id="collapseFour" class="collapse" data-parent="#accordion">
                                            <div class="card-body">
                                                <fieldset>
                                                    <div class="row">
                                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                            <label for="input-cardname">Name on Card <span class="required-f">*</span></label>
                                                            <input name="cardname" value="" placeholder="Card Name" id="input-cardname" class="form-control" type="text">
                                                        </div>
                                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                            <label for="input-country">Credit Card Type <span class="required-f">*</span></label>
                                                            <select name="country_id" class="form-control">
                                                                <option value=""> --- Please Select --- </option>
                                                                <option value="1">American Express</option>
                                                                <option value="2">Visa Card</option>
                                                                <option value="3">Master Card</option>
                                                                <option value="4">Discover Card</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                            <label for="input-cardno">Credit Card Number  <span class="required-f">*</span></label>
                                                            <input name="cardno" value="" placeholder="Credit Card Number" id="input-cardno" class="form-control" type="text">
                                                        </div>
                                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                            <label for="input-cvv">CVV Code <span class="required-f">*</span></label>
                                                            <input name="cvv" value="" placeholder="Card Verification Number" id="input-cvv" class="form-control" type="text">
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                            <label>Expiration Date <span class="required-f">*</span></label>
                                                            <input type="date" name="exdate" class="form-control">
                                                        </div>
                                                        <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                            <img class="padding-25px-top xs-padding-5px-top" src="assets/images/payment-img.jpg" alt="card" title="card" />
                                                        </div>
                                                    </div>
                                                </fieldset>

                                            </div>
                                        </div>
                                    </div> -->


                                </div>
                            </div>

                            <div class="order-button-payment" >
                                
                                <span id="chooseAddressMessage" style="color: red; display: none;">Please choose an address before placing the order.</span>
                                <a class="btn btn-place-order" style="background-color: cadetblue;" value="Place order" type="submit">Place order</a>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
<%-include('footer')-%>

<script>
    document.addEventListener('DOMContentLoaded', function () {
      const removeButtons = document.querySelectorAll('.billingAddress__remove');
      removeButtons.forEach(button => {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          const addressId = button.dataset.addressId;
          const userId = button.dataset.userId

          console.log(addressId);//its get
          console.log(userId);
          console.log(999);

          fetch(`/${userId}/remove/${addressId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                },
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            window.location.reload();
          })
          .catch(error => {
            console.error('Error removing product:', error);
          });
        });
      });
    });
  </script>
 




     <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById("address-form");
    
            form.addEventListener('submit', async function (event) {
                event.preventDefault();
    
                let valid = validateForm();
    
                if (valid) {
                    const formData = new FormData(form);
                    const formObject = {};
                    formData.forEach((value, key) => {
                        formObject[key] = value;
                    });

                    

                    // Now, formObject contains the form values
                    console.log(formObject);
                    try {
                        const response = await fetch("/address-added", {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ formObject  }),
                        });


                        
    
                        if (response.ok) {
                            console.log("Form submitted successfully!");

                            window.location.href = '/checkout';

                        } else {
                            console.error("Form submission failed:", response.statusText);
                        }
                    } catch (error) {
                        console.error("Error during form submission:", error);
                    }
                }
            });
    
            function validateForm() {
                let valid = true;
    
                // Reset previous error messages
                const errorMessages = form.querySelectorAll('.error');
                errorMessages.forEach(function (error) {
                    error.textContent = '';
                });
    
                // Validate User Name
                const name = form.querySelector('#input-name').value.trim();
                if (name === '') {
                    valid = false;
                    displayError('input-name', 'User Name is required.');
                }
    
                const telephone = form.querySelector("#input-telephone").value.trim();
                if (telephone === '' || isNaN(telephone) || telephone.length !== 10) {
                    valid = false;
                    displayError('input-telephone', 'Enter a valid 10-digit number.');
                }
    
                const postcode = form.querySelector("#input-postcode").value.trim();
                if (postcode === '' || isNaN(postcode) || postcode.length !== 6) {
                    valid = false;
                    displayError('input-postcode', 'Enter a valid postcode.');
                }
    
                const cityName = form.querySelector('#input-city').value.trim();
                if (cityName === '') {
                    valid = false;
                    displayError('input-city', 'City is required.');
                }
    
                const address = form.querySelector("#input-homeAddress").value.trim();
                if (address === '') {
                    valid = false;
                    displayError('input-homeAddress', 'Address is required.');
                }
    
                const state = form.querySelector("#input-state").value.trim();
                if (state === '') {
                    valid = false;
                    displayError('input-state', 'State is required.');
                }
    
                return valid;
            }
    
            function displayError(elementId, errorMessage) {
                const errorElement = form.querySelector(`#${elementId} + .error`);
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                }
            }
        });
    </script>

        <!-- Add this script in your HTML file -->
<!-- <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->




<!-- <script>
      document.addEventListener('DOMContentLoaded', function () {
    // Click event for the "Place order" button
    $(".btn-place-order").on("click", function (event) {
      // Prevent the default form submission
      event.preventDefault();
      console.log(444);

      // Get the selected checkbox button value
      var selectedAddress = $("input[name='address-selection']:checked").val();
      var selectedAddress = $("input[name='address-selection']:checked").val();

            // Select the chooseAddressMessage element
            var chooseAddressMessage = $("#chooseAddressMessage");

            if (!selectedAddress) {
                // If no address is selected, show the message and stop the script
                chooseAddressMessage.show();
                return;
            }

            // If an address is selected, hide the message
            chooseAddressMessage.hide();

      // Get the dataset values from the table
      var cartItems = [];
      $("table tbody").find("tr").each(function () {
        var productName = $(this).find("td[data-product-name]").data("product-name");
        var unitPrice = $(this).find("td[data-product-unitPrice]").data("product-unitprice");
        var quantity = $(this).find("td[data-product-quantity]").data("product-quantity");
        var price = $(this).find("td[data-product-price]").data("product-price");

        cartItems.push({
          productName: productName,
          unitPrice: unitPrice,
          quantity: quantity,
          price: price,
        });
      });

      // Get the dataset values from the footer
      var shipping = $("tfoot td[data-shipping-value]").data("shipping-value");
      var tax = $("tfoot td[data-tax-value]").data("tax-value");
      var grandTotal = $("tfoot td[data-grandTotal-value]").data("grandtotal-value");

      // Create an object with all the data
      var orderData = {
        selectedAddress: selectedAddress,
        cartItems: cartItems,
        shipping: shipping,
        tax: tax,
        grandTotal: grandTotal,
      };

      // You can now use the 'orderData' object to send the data to the server or perform any other desired action
      console.log(orderData);
    });
  });


  $("input[name='address-selection']").on("change", function () {
        // Hide the chooseAddressMessage when an address is selected
        $("#chooseAddressMessage").hide();
    });
</script> -->


<script>
    document.addEventListener('DOMContentLoaded', function () {
      // Click event for the "Place order" button
      $(".btn-place-order").on("click", function (event) {
        // Prevent the default form submission
        event.preventDefault();
        console.log(444);
  
        // Get the selected checkbox button value
        // const selectedAddress = $("input[name='address-selection']:checked").val();
        const selectedAddress = $("input[name='address-selection']:checked").data("address-id");
  
        // Select the chooseAddressMessage element
        const chooseAddressMessage = $("#chooseAddressMessage");
  
        if (!selectedAddress) {
          // If no address is selected, show the message and stop the script
          chooseAddressMessage.show();
          return;
        }
  
        // If an address is selected, hide the message
        chooseAddressMessage.hide();
        // Get the dataset values from the table
        const cartItems = [];
        $("table tbody").find("tr").each(function () {
            const productId = $(this).find("td[data-product-id]").data("product-id");
          const productName = $(this).find("td[data-product-name]").data("product-name");
          const unitPrice = $(this).find("td[data-product-unitPrice]").data("product-unitprice");
          const quantity = $(this).find("td[data-product-quantity]").data("product-quantity");
          const price = $(this).find("td[data-product-price]").data("product-price");
          const imagesData = $(this).find("td[data-product-image]").data("product-image")


          console.log(productId);
  
          cartItems.push({
            productId: productId, // Include the productId
            productName: productName,
            unitPrice: unitPrice,
            quantity: quantity,
            images: imagesData, // Include the image data
            price: price,
          });
        });
  
        // Get the dataset values from the footernpm
        const shipping = $("tfoot td[data-shipping-value]").data("shipping-value");
        const tax = $("tfoot td[data-tax-value]").data("tax-value");
        const grandTotal = $("tfoot td[data-grandTotal-value]").data("grandtotal-value");

  
        // Create an object with all the data
        const orderData = {
            
          selectedAddress: selectedAddress,
          orderItems: cartItems,
          shipping: shipping,
          tax: tax,
          grandTotal: grandTotal,
        };
  
        // You can now use the 'orderData' object to send the data to the server or perform any other desired action
        console.log(orderData);
        console.log('placeOrder');
         // Use the Fetch API to send the orderData to the server
    fetch('/placeOrder', {  
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({orderData}),
    })
    .then(response => response.json())
    .then(data => {
      // Handle the response from the server if needed
      console.log(data);
      window.location.href('/place-order')
    })
    .catch(error => {
      console.error('Error:', error);
    });
  });
});
  
    // Change event for the address selection
    $("input[name='address-selection']").on("change", function () {
      // Hide the chooseAddressMessage when an address is selected
      $("#chooseAddressMessage").hide();
    });
  </script>
  








</body>
</html>
