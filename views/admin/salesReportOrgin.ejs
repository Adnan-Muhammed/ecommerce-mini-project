
<%- include('header') -%>

<!-- Add DataTables CSS -->
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>
<!-- Select2 CSS -->
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
  rel="stylesheet"
/>

<!-- jQuery (required) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<!-- DataTable HEADER-->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.6/dist/sweetalert2.min.css"
/>

<!-- Table Start -->
<div class="container-fluid pt-4 px-4">
  <div class="row g-4">
   

    <div class="bg-light rounded h-100 p-4">
      <h6 class="mb-4">Sales Report</h6>

      <div class="table-responsive">
        <table id="my-table" class="table table-bordered">
          <thead>

            <tr class="text-dark">
              <th rowspan="2">User Name</th>
              <th rowspan="2">Order Date</th>
              <th rowspan="2">Grand Total</th>
              <th rowspan="2">Payment Status &<br />Order Status</th>
              <th rowspan="2">Coupon</th>
              <th rowspan="2">Tax</th>
              <th style="text-align: center" colspan="7">Order Items</th>
              <th class="actionBtn" rowspan="2"> </th>
            </tr>
            <tr class="text-dark">
              <th>Product Name</th>
              <th>Unit Price</th>
              <th>Quantity</th>
              <th>Product Price</th>
              <th>Category Offer</th>
              <th>Product Offer</th>
              <th>Total Price</th>
            </tr>
          </thead>
          <tbody>
            <% orders.forEach(order => { %> <% order.orderItems.forEach((item,
            index) => { %>
            <tr class="text-dark">
              <% if (index === 0) { %>
           
              <td rowspan="<%= order.orderItems.length %>">
                <%= order.userName %>
              </td>
              <td rowspan="<%= order.orderItems.length %>">
                <%= new Date(order.orderDate).toLocaleString('en-US', { weekday:
                'short', day: 'numeric', month: 'short', year: 'numeric', hour:
                'numeric', minute: 'numeric', second: 'numeric', hour12: true })
                %>
              </td>
              <td rowspan="<%= order.orderItems.length %>">
                <%= order.grandTotal %>
              </td>
              <td rowspan="<%= order.orderItems.length %>">
                <%= order.paymentStatus.type %>
                <br />
                <%= order.orderStatus.type %>
              </td>
              <td rowspan="<%= order.orderItems.length %>">
                <% if (order.couponName) { %> <%= order.couponName %>
                <br />
                <%= order.couponDiscountPercentage %> %
                <br />
                <%= order.couponDiscount %> <% } else { %> N/A <% } %>
              </td>
              <td rowspan="<%= order.orderItems.length %>"><%= order.tax %></td>
              <% } %>
              <td><%= item.productName %></td>
              <td><%= item.unitPrice %></td>
              <td><%= item.quantity %></td>
              <td><%= item.price %></td>
              <td>
                <%= item.categoryDiscountPecentage %>%
                <br />
                <%= item.categoryOffer %>
              </td>
              <td>
                <%= item.productDiscountPercentage %>%
                <br />
                <%= item.productOffer %>
              </td>
              <td><%= item.totalPrice %></td>
              <% if (index === 0) { %>
              <td rowspan="<%= order.orderItems.length %>">
                <a class="actionBtn  " href=""></a>
              </td>
              <% } %>
            </tr>
            <% }); %> <% }); %>
          </tbody>
        </table>
        <button onclick="downloadPDF()" class="btn btn-sm btn-primary">
          Download PDF
        </button>
        <button onclick="downloadExcel()" class="btn btn-sm btn-primary">
          Download Excel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- table -->

<!-- JavaScript code to generate and download PDF     and EXcel-->





 <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
<script>
function downloadExcel(fileType = 'xlsx') {
    // Clone the table
    const tableClone = document.querySelector('table').cloneNode(true);

    // Remove the action button cells
    const actionCells = tableClone.querySelectorAll('td[rowspan], th[rowspan]');
    

    actionCells.forEach(cell => {
        if (cell.innerText.trim() === "download pdf"     ) {

          console.log(cell);
          cell.parentNode.removeChild(cell);
        }
    });

    const actionHeader = tableClone.querySelector('.actionBtn');

          actionHeader.parentNode.removeChild(actionHeader);
      
    
    // Convert the modified table to a worksheet
    const ws = XLSX.utils.table_to_sheet(tableClone);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sales Report');
    XLSX.writeFile(wb, `sales_report.${fileType}`);
}
</script> 



<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
  function downloadPDF() {
  // Remove the content of the "action" cell in each row
  // const element = document.querySelector('table');
  const tableClone = document.querySelector('table').cloneNode(true);
    // Remove the action button cells
    const actionCells = tableClone.querySelectorAll('td[rowspan], th[rowspan]');
    actionCells.forEach(cell => {
        if (cell.innerText.trim() === "download pdf"     ) {

          console.log(cell);
          cell.innerText="";
        }
    });

    const actionHeader = tableClone.querySelector('.actionBtn');
          actionHeader.innerText =""
      
  const options = {
    filename: 'document.pdf',
    image: { type: 'pdf', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { format: 'letter', orientation: 'landscape', unit: 'in' },
    width:100,
    margin: [0.5, 0.2],
    pagebreak: { mode: 'avoid-all' }
  };
  html2pdf()
    .from(tableClone)
    .set(options)
    .save();
  }
</script> 






<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<!-- Add DataTables JavaScript -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script src="https://cdn.datatables.net/v/bs5/dt-1.13.8/datatables.min.js"></script>



<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
     $(document).ready(function() {
        // Initialize DataTable
        $('#my-table').DataTable({
            paging: true, // Enable pagination
            pageLength: 5, // Set the default page length to 5

            lengthMenu: [[5, 25, 50, -1], [5, 25, 50, "All"]], // Customize the display length options
            searching: true, // Enable searching
            ordering: true, // Enable sorting
            info: true, // Show information about the table
            dom: 'Blfrtip', // Add buttons for export and column visibility
            buttons: [
                'colvis', // Column visibility
                'csv', // Export as CSV
                'excel', // Export as Excel
                'pdf' // Export as PDF
            ], // Enable exporting data to various formats
            responsive: true, // Make the table responsive
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/English.json' // Set language to English
            }
        });
    });
</script>



<!-- JavaScript Code for PDF Download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
<script>
  // JavaScript Code for Downloading PDF
</script>

<!-- Add jsPDF and html2canvas libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>

<%- include('footer') -%>